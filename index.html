<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard V2 | Enactus FTU Hanoi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: {
                        enactus: { DEFAULT: '#FFC107', hover: '#FFB300', light: '#FFF8E1' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 800: '#1F2937' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F3F4F6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        
        .nav-item.active {
            background-color: #FFF8E1; color: #B45309; border-right: 4px solid #FFC107;
        }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #FFC107; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden selection:bg-enactus selection:text-white">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-sm z-20">
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div class="w-10 h-10 bg-enactus rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3 shadow-md">E</div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">Enactus FTU</h1>
                <p class="text-xs text-gray-400 font-medium">HR Management</p>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <div class="px-4 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Main Menu</div>
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-6 py-3.5 text-sm font-medium transition-all hover:bg-gray-50 group">
                <i class="fa-solid fa-chart-pie w-6 text-gray-400 group-hover:text-enactus transition-colors"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" onclick="switchTab('members')" id="nav-members" class="nav-item flex items-center px-6 py-3.5 text-sm font-medium transition-all hover:bg-gray-50 group">
                <i class="fa-solid fa-users w-6 text-gray-400 group-hover:text-enactus transition-colors"></i>
                <span>Thành viên</span>
            </a>
            <a href="#" onclick="switchTab('accounts')" id="nav-accounts" class="nav-item flex items-center px-6 py-3.5 text-sm font-medium transition-all hover:bg-gray-50 group">
                <i class="fa-solid fa-shield-halved w-6 text-gray-400 group-hover:text-enactus transition-colors"></i>
                <span>Tài khoản</span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-50 hover:bg-enactus-light cursor-pointer transition-colors" onclick="logout()">
                <div class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center font-bold">A</div>
                <div class="flex-1">
                    <p class="text-sm font-bold text-gray-800">Admin User</p>
                    <p class="text-xs text-gray-500">Super Admin</p>
                </div>
                <i class="fa-solid fa-right-from-bracket text-gray-400"></i>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-gray-200 flex items-center justify-between px-8 z-10">
            <h2 id="page-title" class="text-2xl font-bold text-gray-800">Tổng quan</h2>
            <div class="flex items-center gap-4">
                <div class="h-8 w-[1px] bg-gray-300 mx-2"></div>
                <span class="text-sm font-medium text-gray-500" id="current-date">...</span>
            </div>
        </header>

        <div id="loading-overlay" class="absolute inset-0 bg-white/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
            <div class="bg-white p-5 rounded-2xl shadow-xl flex flex-col items-center">
                <div class="loader mb-3"></div>
                <p class="text-sm font-medium text-gray-500">Đang xử lý dữ liệu...</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-8" id="content-area">
            
            <div id="view-dashboard" class="view-section animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Tổng thành viên</p>
                        <h3 class="text-3xl font-extrabold text-gray-800" id="stat-total">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Đang hoạt động</p>
                        <h3 class="text-3xl font-extrabold text-gray-800" id="stat-active">0</h3>
                    </div> 
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Gen Mới nhất</p>
                        <h3 class="text-3xl font-extrabold text-gray-800">Gen 17</h3>
                    </div> 
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-orange-50 rounded-bl-full -mr-4 -mt-4"></div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Dự án</p>
                        <h3 class="text-3xl font-extrabold text-gray-800">3</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-6">Nhân sự theo Ban</h3>
                        <div class="h-64"><canvas id="mainChart"></canvas></div>
                    </div>
                    
                    <div class="flex flex-col gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-6">Trạng thái</h3>
                            <div class="h-48 flex justify-center"><canvas id="statusChart"></canvas></div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex-1 flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-cake-candles text-pink-500"></i> Sinh nhật tháng này
                            </h3>
                            <div class="flex-1 overflow-y-auto max-h-[300px] pr-2 space-y-3" id="birthday-list">
                                <p class="text-xs text-gray-400 italic text-center py-4">Đang tải...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-members" class="view-section hidden animate-fade-in">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                    <div class="relative w-full md:w-96">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="member-search" onkeyup="filterMembers()" class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enactus transition" placeholder="Tìm tên, ID, ban...">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportExcel('members')" class="px-4 py-2.5 rounded-lg border border-gray-200 text-gray-600 text-sm font-medium hover:bg-gray-50 transition flex items-center gap-2"><i class="fa-solid fa-file-excel text-green-600"></i> Excel</button>
                        <button onclick="openModal()" class="px-4 py-2.5 rounded-lg bg-enactus text-white text-sm font-bold hover:bg-enactus-hover shadow-lg transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> Thêm mới</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-500 font-semibold">
                                    <th class="px-6 py-4">Thành viên</th>
                                    <th class="px-6 py-4">ID & Gen</th>
                                    <th class="px-6 py-4">Ban</th>
                                    <th class="px-6 py-4">Vị trí</th>
                                    <th class="px-6 py-4 text-center">Trạng thái</th>
                                    <th class="px-6 py-4 text-center">Thao tác</th> 
                                </tr>
                            </thead>
                            <tbody id="member-table-body" class="text-sm divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <div id="member-empty" class="hidden flex flex-col items-center justify-center py-12 text-center">
                        <i class="fa-solid fa-folder-open text-gray-300 text-3xl mb-2"></i>
                        <p class="text-gray-500 text-xs">Không tìm thấy dữ liệu</p>
                    </div>
                </div>
            </div>

            <div id="view-accounts" class="view-section hidden animate-fade-in">
                 <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center gap-4 mb-6">
                    <div class="relative w-full md:w-96">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="account-search" onkeyup="filterAccounts()" class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enactus transition" placeholder="Tìm username...">
                    </div>
                    <button onclick="exportExcel('accounts')" class="px-4 py-2.5 rounded-lg border border-gray-200 text-gray-600 text-sm font-medium hover:bg-gray-50 transition flex items-center gap-2"><i class="fa-solid fa-file-excel text-green-600"></i> Excel</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-500 font-semibold">
                                <th class="px-6 py-4">Account</th>
                                <th class="px-6 py-4">Role</th>
                                <th class="px-6 py-4">Liên kết</th>
                                <th class="px-6 py-4 text-center">Status</th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="account-table-body" class="text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>
    <div id="add-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-50 hidden scale-95 transition-all duration-300 opacity-0">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
            <h3 class="text-lg font-bold text-gray-800" id="modal-title">Thêm Thành viên</h3>
            <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <form id="add-form" onsubmit="submitForm(event)" class="p-8">
            <input type="hidden" id="inp-id" value=""> <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Họ tên *</label><input type="text" id="inp-name" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ngày sinh *</label><input type="date" id="inp-dob" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ban *</label>
                        <select id="inp-dept" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none">
                            <option value="MD">Truyền thông (MD)</option><option value="ER">Đối ngoại (ER)</option><option value="HR">Nhân sự (HR)</option><option value="PD">Dự án (PD)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Số điện thoại</label><input type="tel" id="inp-phone" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none"></div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gen *</label><input type="number" id="inp-gen" value="17" required class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Vị trí</label>
                            <select id="inp-pos" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none">
                                <option value="Thành viên">Thành viên</option><option value="Trưởng ban">Trưởng ban</option><option value="Phó ban">Phó ban</option><option value="Chủ tịch">Chủ tịch</option>
                            </select>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email cá nhân</label><input type="email" id="inp-email" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none"></div>
                    <div id="role-group"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Role (Tài khoản)</label>
                        <select id="inp-role" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-enactus outline-none">
                            <option value="Member">Member</option><option value="Admin">Admin</option><option value="Super Admin">Super Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="auto-note" class="bg-yellow-50 p-4 rounded-xl flex gap-3 mb-6 text-sm text-gray-600"><i class="fa-solid fa-lightbulb text-enactus mt-0.5"></i><div><span class="font-bold">Auto:</span> ID (MD.17.2507) & User (<a href="#" class="text-blue-600">user.enactusftu@gmail.com</a>) & Pass (Enactus@123)</div></div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                <button type="button" onclick="closeModal()" class="px-5 py-2.5 rounded-lg border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">Hủy</button>
                <button type="submit" class="px-5 py-2.5 rounded-lg bg-enactus text-white font-bold hover:bg-enactus-hover shadow-lg">Xác nhận</button>
            </div>
        </form>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // CONFIG
        const SB_URL = 'https://tkagnktiqdstmsycgamk.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrYWdua3RpcWRzdG1zeWNnYW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjY3MzUsImV4cCI6MjA4NTU0MjczNX0.AQTs-WeQ6zMenItpO9Fe1kSTw7XU53sv8JU6A04iLXg';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        let membersData = [], accountsData = [];

        document.getElementById('current-date').innerText = new Date().toLocaleDateString('vi-VN', {weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'});

        function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
        function removeTones(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D').toLowerCase(); }
        
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = tab === 'dashboard' ? 'Tổng quan' : (tab === 'members' ? 'Thành viên' : 'Tài khoản');
        }

        function genId(dept, gen, dob) {
            const d = new Date(dob);
            return `${dept}.${gen}.${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}`;
        }

        async function genUser(name) {
            const clean = removeTones(name.trim()).split(' ');
            if (!clean.length) return 'user'+Math.floor(Math.random()*999);
            let base = clean[clean.length-1];
            for(let i=0; i<clean.length-1; i++) base += clean[i][0];
            let user = base, count = 0, isUnique = false;
            while(!isUnique) {
                const { data } = await supabaseClient.from('accounts').select('username').eq('username', user);
                if(data && data.length) user = base + (++count); else isUnique = true;
            }
            return user;
        }

        async function fetchData() {
            showLoading(true);
            try {
                const { data: m } = await supabaseClient.from('members').select('*').order('created_at',{ascending:false});
                membersData = m || [];
                const { data: a } = await supabaseClient.from('accounts').select('*, members(full_name)').order('created_at',{ascending:false});
                accountsData = a || [];
                renderAll();
            } catch (e) { Swal.fire('Lỗi', e.message, 'error'); } finally { showLoading(false); }
        }

        async function submitForm(e) {
            e.preventDefault();
            showLoading(true);
            try {
                const editId = document.getElementById('inp-id').value;
                const vals = {
                    name: document.getElementById('inp-name').value,
                    dob: document.getElementById('inp-dob').value,
                    dept: document.getElementById('inp-dept').value,
                    gen: document.getElementById('inp-gen').value,
                    pos: document.getElementById('inp-pos').value,
                    email: document.getElementById('inp-email').value,
                    phone: document.getElementById('inp-phone').value,
                    role: document.getElementById('inp-role').value
                };

                if (editId) {
                    // Update
                    const { error } = await supabaseClient.from('members').update({
                        full_name: vals.name, dob: vals.dob, gen: vals.gen,
                        department: vals.dept, position: vals.pos, email_personal: vals.email,
                        phone: vals.phone
                    }).eq('id', editId);
                    if(error) throw error;
                    Swal.fire('Cập nhật thành công', '', 'success');
                } else {
                    // Create
                    const mid = genId(vals.dept, vals.gen, vals.dob);
                    const user = await genUser(vals.name);
                    const workEmail = `${user}.enactusftu@gmail.com`;

                    const { data: newM, error: e1 } = await supabaseClient.from('members').insert([{
                        member_code: mid, full_name: vals.name, dob: vals.dob, gen: vals.gen,
                        department: vals.dept, position: vals.pos, email_personal: vals.email,
                        phone: vals.phone, 
                        email_work: workEmail, status: 'Active'
                    }]).select();
                    if(e1) throw e1;

                    const { error: e2 } = await supabaseClient.from('accounts').insert([{
                        member_id: newM[0].id, username: user, password: 'Enactus@123',
                        role: vals.role, is_active: true
                    }]);
                    if(e2) throw e2;
                    Swal.fire('Thành công', `Đã tạo ${vals.name}<br>Email: ${workEmail}`, 'success');
                }
                closeModal();
                fetchData();
            } catch (err) { Swal.fire('Lỗi', err.message, 'error'); } finally { showLoading(false); }
        }

        async function deleteMember(id) {
            const res = await Swal.fire({title:'Xóa thành viên?', text:"Không thể hoàn tác!", icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'Xóa', cancelButtonText:'Hủy'});
            if (res.isConfirmed) {
                showLoading(true);
                const { error } = await supabaseClient.from('members').delete().eq('id', id);
                showLoading(false);
                if (error) Swal.fire('Lỗi', error.message, 'error'); else { Swal.fire('Đã xóa', '', 'success'); fetchData(); }
            }
        }

        function editMember(id) {
            const m = membersData.find(x => x.id === id);
            if(!m) return;
            openModal(true);
            document.getElementById('modal-title').innerText = 'Cập nhật Thành viên';
            document.getElementById('inp-id').value = m.id;
            document.getElementById('inp-name').value = m.full_name;
            document.getElementById('inp-dob').value = m.dob;
            document.getElementById('inp-dept').value = m.department;
            document.getElementById('inp-gen').value = m.gen;
            document.getElementById('inp-pos').value = m.position;
            document.getElementById('inp-email').value = m.email_personal || '';
            document.getElementById('inp-phone').value = m.phone || '';
            document.getElementById('role-group').classList.add('hidden');
            document.getElementById('auto-note').classList.add('hidden');
        }

        function viewMember(id) {
            const m = membersData.find(x => x.id === id);
            if(!m) return;
            Swal.fire({
                title: `<span class="text-enactus">${m.full_name}</span>`,
                html: `<div class="text-left space-y-2 text-sm"><p><strong>Mã TV:</strong> ${m.member_code}</p><p><strong>Ban:</strong> ${m.department} - Gen ${m.gen}</p><p><strong>Vị trí:</strong> ${m.position}</p><p><strong>Ngày sinh:</strong> ${new Date(m.dob).toLocaleDateString('vi-VN')}</p><p><strong>Email công việc:</strong> ${m.email_work}</p><p><strong>Email cá nhân:</strong> ${m.email_personal || 'N/A'}</p><p><strong>SĐT:</strong> ${m.phone || 'N/A'}</p><p><strong>Trạng thái:</strong> ${m.status}</p></div>`,
                confirmButtonColor: '#FFC107'
            });
        }

        async function resetPass(id) {
            const res = await Swal.fire({title:'Reset mật khẩu?', text:'Về mặc định: Enactus@123', icon:'warning', showCancelButton:true, confirmButtonColor:'#FFC107'});
            if(res.isConfirmed) {
                showLoading(true);
                const { error } = await supabaseClient.from('accounts').update({password:'Enactus@123'}).eq('id',id);
                showLoading(false);
                if(!error) Swal.fire('Xong', 'Đã reset', 'success');
            }
        }

        function renderAll() {
            document.getElementById('stat-total').innerText = membersData.length;
            document.getElementById('stat-active').innerText = membersData.filter(m=>m.status==='Active').length;
            renderBirthdays();

            const depts = {MD:0,ER:0,HR:0,PD:0};
            membersData.forEach(m => { if(depts[m.department]!==undefined) depts[m.department]++ });
            
            if(window.c1) window.c1.destroy();
            window.c1 = new Chart(document.getElementById('mainChart'), { type:'bar', data:{labels:['MD','ER','HR','PD'], datasets:[{data:[depts.MD,depts.ER,depts.HR,depts.PD], backgroundColor:['#3B82F6','#EC4899','#F59E0B','#6366F1'], borderRadius:6}]}, options:{plugins:{legend:{display:false}}, scales:{y:{grid:{display:false}},x:{grid:{display:false}}}}});
            
            if(window.c2) window.c2.destroy();
            window.c2 = new Chart(document.getElementById('statusChart'), { type:'doughnut', data:{labels:['Active','Inactive'], datasets:[{data:[document.getElementById('stat-active').innerText, membersData.length - parseInt(document.getElementById('stat-active').innerText)], backgroundColor:['#10B981','#E5E7EB'], borderWidth:0}]}, options:{cutout:'75%', plugins:{legend:{position:'bottom'}}}});

            renderMembers(); renderAccounts();
        }

        function renderBirthdays() {
            const currentMonth = new Date().getMonth() + 1;
            const bdays = membersData.filter(m => { if(!m.dob) return false; const d = new Date(m.dob); return (d.getMonth() + 1) === currentMonth; }).sort((a,b) => new Date(a.dob).getDate() - new Date(b.dob).getDate());
            const container = document.getElementById('birthday-list');
            if(bdays.length === 0) {
                container.innerHTML = `<div class="text-center py-6"><i class="fa-solid fa-gift text-gray-200 text-3xl mb-2"></i><p class="text-xs text-gray-400">Không có sinh nhật trong tháng ${currentMonth}</p></div>`;
            } else {
                container.innerHTML = bdays.map(m => {
                    const date = new Date(m.dob);
                    return `<div class="flex items-center p-3 rounded-lg bg-gray-50 hover:bg-yellow-50 transition border border-gray-100"><div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center font-bold text-enactus shadow-sm mr-3">${date.getDate()}</div><div><p class="text-sm font-bold text-gray-800">${m.full_name}</p><p class="text-xs text-gray-500">${m.department} - Gen ${m.gen}</p></div></div>`;
                }).join('');
            }
        }

        function renderMembers() {
            const term = document.getElementById('member-search').value.toLowerCase();
            const list = membersData.filter(m => m.full_name.toLowerCase().includes(term) || m.member_code.toLowerCase().includes(term));
            document.getElementById('member-empty').classList.toggle('hidden', list.length > 0);
            document.getElementById('member-table-body').innerHTML = list.map(m => {
                const colors = {'MD':'blue','ER':'pink','HR':'yellow','PD':'indigo'}; const c = colors[m.department] || 'gray';
                return `<tr class="hover:bg-gray-50 transition border-b border-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">${m.full_name}</td>
                    <td class="px-6 py-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-mono font-bold">${m.member_code}</span><div class="text-xs text-gray-400 mt-1">Gen ${m.gen}</div></td>
                    <td class="px-6 py-4"><span class="bg-${c}-50 text-${c}-600 border border-${c}-100 px-2 py-1 rounded-full text-xs font-bold">${m.department}</span></td>
                    <td class="px-6 py-4 text-gray-600">${m.position}</td>
                    <td class="px-6 py-4 text-center"><span class="w-2 h-2 rounded-full inline-block mr-1 ${m.status==='Active'?'bg-green-500':'bg-gray-300'}"></span>${m.status}</td>
                    <td class="px-6 py-4 text-center"><div class="flex items-center justify-center gap-2">
                        <button onclick="viewMember('${m.id}')" class="w-8 h-8 rounded hover:bg-blue-50 text-blue-500 flex items-center justify-center transition" title="Xem"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="editMember('${m.id}')" class="w-8 h-8 rounded hover:bg-orange-50 text-orange-500 flex items-center justify-center transition" title="Sửa"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteMember('${m.id}')" class="w-8 h-8 rounded hover:bg-red-50 text-red-500 flex items-center justify-center transition" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                    </div></td>
                </tr>`
            }).join('');
        }
        function renderAccounts() {
            const term = document.getElementById('account-search').value.toLowerCase();
            const list = accountsData.filter(a => a.username.toLowerCase().includes(term));
            document.getElementById('account-table-body').innerHTML = list.map(a => `<tr class="hover:bg-gray-50 transition border-b border-gray-50"><td class="px-6 py-4 font-bold text-gray-800">${a.username}<div class="text-xs font-normal text-gray-400">${a.username}.enactusftu@gmail.com</div></td><td class="px-6 py-4"><span class="bg-gray-50 border border-gray-200 px-2 py-1 rounded text-xs font-medium">${a.role}</span></td><td class="px-6 py-4 text-gray-600">${a.members ? a.members.full_name : '<span class="text-red-400 italic text-xs">Chưa liên kết</span>'}</td><td class="px-6 py-4 text-center text-lg">${a.is_active ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-solid fa-circle-xmark text-red-400"></i>'}</td><td class="px-6 py-4 text-right"><button onclick="resetPass('${a.id}')" class="text-xs border border-gray-200 rounded px-2 py-1 hover:border-orange-400 hover:text-orange-500 transition">Reset</button></td></tr>`).join('');
        }
        
        function filterMembers() { renderMembers(); } function filterAccounts() { renderAccounts(); }
        function openModal(isEdit = false) { 
            document.getElementById('modal-backdrop').classList.remove('hidden','opacity-0'); document.getElementById('add-modal').classList.remove('hidden','opacity-0','scale-95'); document.getElementById('add-modal').classList.add('opacity-100','scale-100');
            if(!isEdit) { document.getElementById('add-form').reset(); document.getElementById('modal-title').innerText = 'Thêm Thành viên'; document.getElementById('inp-id').value = ''; document.getElementById('role-group').classList.remove('hidden'); document.getElementById('auto-note').classList.remove('hidden'); document.getElementById('inp-gen').value = 17; }
        }
        function closeModal() { document.getElementById('add-modal').classList.remove('opacity-100','scale-100'); document.getElementById('add-modal').classList.add('opacity-0','scale-95'); document.getElementById('modal-backdrop').classList.add('opacity-0'); setTimeout(()=>{ document.getElementById('add-modal').classList.add('hidden'); document.getElementById('modal-backdrop').classList.add('hidden'); },300); }
        function logout() { Swal.fire({title:'Đăng xuất?',icon:'question',showCancelButton:true,confirmButtonColor:'#FFC107'}).then(r=>{if(r.isConfirmed)location.reload()}) }
        function exportExcel(t) { const ws=XLSX.utils.json_to_sheet(t==='members'?membersData:accountsData), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,`Export_${t}.xlsx`); }
        
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>